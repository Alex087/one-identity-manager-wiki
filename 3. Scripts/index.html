<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>3. Scripts - 1IM Wiki</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" >
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">1IM Wiki</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="true">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#sql" class="nav-link">SQL запрос</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#join-orderby" class="nav-link">С использованием Join и OrderBy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#insert" class="nav-link">Не создается запись в БД Insert через тестирование скрипта</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#insert_1" class="nav-link">Создание записи в БД Insert</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_1" class="nav-link">Удаление записи из БД</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_2" class="nav-link">Обновление записи в БД</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#where" class="nav-link">Сложный Where</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#ad-account-definition" class="nav-link">Для получения информации по наличии AD Account Definition у сотрудника для почтового шаблона оповещения согласующего при назначении режима доступа</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_3" class="nav-link">Работа с объектом</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#update" class="nav-link">Update таблицы</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#sql_1" class="nav-link">SQL запрос</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_4" class="nav-link">Добавление в массив уникальных значений из другого массива</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#-" class="nav-link">Вычисление кол-ва согласующих по точкам зрения</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_5" class="nav-link">Вывод в шаблоне построчно из массива</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#objectwalker" class="nav-link">ObjectWalker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_6" class="nav-link">Глобальные и локальные переменные</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#allocating-parameter-values" class="nav-link">Allocating Parameter Values</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_7" class="nav-link">Логирование</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#ccc_vid_write2log" class="nav-link">CCC_VID_Write2Log</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_8" class="nav-link">Строки</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#where_1" class="nav-link">WHERE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#export-to-csv" class="nav-link">EXPORT TO CSV</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#csvexportsingle" class="nav-link">CSVExportSingle</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_9" class="nav-link">Формат даты</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#objectwalker_1" class="nav-link">ObjectWalker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#greenplum-postgress" class="nav-link">Взаимодействие с GreenPlum (Postgress)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_10" class="nav-link">Кавычки в скриптах</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>3. Scripts</p>
<p>27 февраля 2020 г.</p>
<p>14:48</p>
<table>
<thead>
<tr>
<th><strong>Script</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Script (OnDiscarded)</td>
<td>The script is run after the object is discarded.</td>
</tr>
<tr>
<td>Script (OnDiscarding)</td>
<td>The script is run before the object is discarded.</td>
</tr>
<tr>
<td>Script (OnLoaded)</td>
<td>The script is run after the object is loaded.</td>
</tr>
<tr>
<td>Script (OnSaved)</td>
<td>The script is run after the object is saved.</td>
</tr>
<tr>
<td>Script (OnSaving)</td>
<td>The script is run before the object is saved.</td>
</tr>
</tbody>
</table>
<p>*From
 \&lt;&lt;https://support.oneidentity.com/technical-documents/identity-manager/8.0/configuration-guide/29*</p>
<p><strong>Оповещение о пользователях, которые будут скоро уволены</strong></p>
<pre><code>Public Function Z_Notify_Upcoming_User_Termination() As String

Dim timeSqlParts As New List(Of String)

For Each nextTimeDiff As String In {&quot;0&quot;, &quot;5&quot;, &quot;10&quot;}

timeSqlParts.Add(&quot;DATEADD(DD,&quot; &amp; nextTimeDiff &amp; &quot;,CAST(getdate() AS  
Date))=cast(ExitDate as date)&quot;)

Next

Dim items As IColDbObject = Nothing

items = Connection.CreateCol(&quot;Person&quot;)

items.Prototype(&quot;UID_Person&quot;).IsDisplayItem = True

items.Prototype(&quot;UID_PersonHead&quot;).IsDisplayItem = True

items.Prototype.WhereClause = &quot;ExitDate is not null and IsInActive=0  
and IsExternal=1 and (&quot; &amp; String.Join(&quot; or &quot;, timeSqlParts) &amp; &quot;)&quot;

items.Prototype.OrderBy = &quot;internalname&quot;

items.Load()

logger.Trace(&quot;pending termination count: &quot; &amp; items.Count)

Dim managersToUsers As New Dictionary(Of String, List(Of String))

For Each nextOp As IColElem In items

Dim managerId = nextOp.GetValue(&quot;UID_PersonHead&quot;).String

Dim persId = nextOp.GetValue(&quot;UID_Person&quot;).String

If Not String.IsNullOrEmpty(managerId) Then

Z_Dictionary_Put_If_Absent(managersToUsers, managerId, New List(Of  
String))

managersToUsers.Item(managerId).Add(persId)

End If

Next

For Each nextManager As String In managersToUsers.Keys

Try

Dim userIds As List(Of String) = managersToUsers.Item(nextManager)

logger.Trace(&quot;sending upcoming termination mail with &quot; &amp; userIds.Count  
&amp; &quot; users (&quot; &amp; String.Join(&quot;, &quot;, userIds) &amp; &quot;) to &quot; &amp; nextManager)

Dim toEmail As String = Connection.CreateSingle(&quot;Person&quot;,  
nextManager).GetValue(&quot;DefaultEmailAddress&quot;).String

Dim emailParams As New Dictionary(Of String, Object)

emailParams.Add(&quot;userIds&quot;, userIds)

emailParams.Add(&quot;Receiver&quot;, nextManager)

Z_Send_Html_Mail_With_Template(toEmail, &quot;Z_Upcoming_Termination&quot;,  
emailParams)

Catch ex As Exception

logger.Error(ex, &quot;error hile sending mail to &quot; &amp; nextManager)

End Try

Next

Return &quot;ok&quot;

End Function
</code></pre>
<hr />
<p><strong>Параметр в переменную (скрипт отправки почты)</strong></p>
<pre><code>  #If Not SCRIPTDEBUGGER Then

 Imports System.Collections.Generic

 Imports System.Net.Mail

 #End If

  

 toAddress =
 Connection.GetConfigParm(&quot;Common\MailNotification\RedirectAllMailsTo&quot;)

 /////////////////////////////////////////////////////////////////////////////////////////////////////

 Sub Z_Send_Mail(ByVal toAddress As String, ByVal subject As String,
 ByVal body As String, isHTML As Boolean, Optional dontCatchError As
 Boolean = False)

 If Not
 String.IsNullOrWhiteSpace(Connection.GetConfigParm(&quot;Common\MailNotification\RedirectAllMailsTo&quot;))
 Then

 toAddress =
 Connection.GetConfigParm(&quot;Common\MailNotification\RedirectAllMailsTo&quot;)

 logger.trace(&quot;system configured to redirect all mails to &quot; &amp;
 toAddress)

 End If

 If String.IsNullOrEmpty(toAddress) Then

 logger.Warn(&quot;toAddress is empty for message with subject = &quot; &amp; subject
 &amp; &quot;; body = &quot; &amp; body)

 Return

 End If

 If
 String.IsNullOrEmpty(Connection.GetConfigParm(&quot;Common\MailNotification\DefaultSender&quot;))
 OrElse
 String.IsNullOrEmpty(Connection.GetConfigParm(&quot;Common\MailNotification\SMTPRelay&quot;))
 Then

 logger.Warn(&quot;SMTP server is not configured for message with subject =
 &quot; &amp; subject &amp; &quot;; body = &quot; &amp; body)

 Return

 End If

 Try

 **Dim Smtp_Server As New SmtpClient**

 **Dim e_mail As New MailMessage()**

 **' Smtp_Server.UseDefaultCredentials = False**

 **' Smtp_Server.Credentials = New Net.NetworkCredential(
 Connection.GetConfigParm(&quot;Common\MailNotification\SMTPDomain&quot;) &amp; &quot;\\ &amp;
 Connection.GetConfigParm(&quot;Common\MailNotification\SMTPAccount&quot;),
 Connection.GetConfigParm(&quot;Common\MailNotification\SMTPPassword&quot;))**

 **Smtp_Server.Port =
 Convert.toInt32(Connection.GetConfigParm(&quot;Common\MailNotification\SMTPPort&quot;))**

 **Smtp_Server.EnableSsl = False**

 **Smtp_Server.Host =
 Connection.GetConfigParm(&quot;Common\MailNotification\SMTPRelay&quot;)**

 **e_mail = New MailMessage()**

 **e_mail.From = New
 MailAddress(Connection.GetConfigParm(&quot;Common\MailNotification\DefaultSender&quot;))**

 **For Each addr As String In toAddress.Split(&quot;,&quot;c)**

 **e_mail.To.Add(addr.trim())**

 **Next**

 **e_mail.Subject = subject**

 **e_mail.IsBodyHtml = isHTML**

 **e_mail.Body = body**

 **Smtp_Server.Send(e_mail)**

 Catch ex As Exception

 logger.error(ex, &quot;error while sending mesage with subject = &quot; &amp;
 subject &amp; &quot;; body = &quot; &amp; body &amp; &quot; to &quot; &amp; toAddress)

 If dontCatchError Then

 Throw ex

 End If

 End Try

 End Sub
</code></pre>
<hr />
<p><strong>Создание учетки SfB</strong></p>
<pre><code>Public Function Z_Connector_Skype_Add_Account(account As
 SingleDbObjectSnapshot) As String

 Dim scriptText As String = Z_Get_Email_Template_Body(&quot;Z_Skype_Create&quot;)

 Dim output As New List(Of String)

 'output.Add(&quot;userDataJSON&quot;)

 Dim scriptParams As New Dictionary(Of String, Object)

 scriptParams.Add(&quot;guid&quot;, account.GetValue(&quot;ObjectGUID&quot;).String)

 scriptParams.Add(&quot;pool&quot;, account.GetValue(&quot;CCC_RegistrarPool&quot;).String)

 scriptParams.Add(&quot;sip&quot;, account.GetValue(&quot;CCC_SipAddress&quot;).String)

 Dim results As IDictionary(Of String, Object) =
 Z_Run_PowerShell(scriptText, scriptParams, output)

 'Dim outputLines = CType(results.Item(&quot;\_\_OUTPUT\_\_&quot;), List(Of
 String))

 'logger.Trace(&quot;outputLines = &quot; &amp; String.Join(vbCrLf, outputLines))

 Try

 Z_Send_Mail_New_Account_To_ISA(account.GetValue(&quot;XObjectKey&quot;).String)

 Catch ex As Exception

 logger.Error(ex, &quot;error while sending mail to ISA&quot;)

 End Try

 Z_Assign_Add_Group(account.GetValue(&quot;UID_Person&quot;).String,
 Connection.GetConfigParm(&quot;TargetSystem\UNS\ITResource\Skype\DefaultGroupCN&quot;))

 Return account.GetValue(&quot;ObjectGUID&quot;).String

 End Function

 /////////

 *Z_Skype_Create*

 param(\$guid, \$pool, \$sip)

 \$ErrorActionPreference = &quot;Stop&quot;

 import-module SkypeForBusiness

 \$trgUser = Get-CsAdUser –Identity \$guid

 If(\$trgUser.Enabled -eq \$null){

 Write-output &quot;lync account not found; trying to create&quot;

 try {

 Enable-CSUser \$guid -RegistrarPool \$pool -SipAddress \$sip

 } catch {

 \$ErrorMessage = \$\_.Exception.

 Write-output \$ErrorMessage

 if (\$ErrorMessage -eq &quot;The EXECUTE permission was denied on the
 object 'XdsPublishItems', database 'xds', schema 'dbo'.&quot; ) {

 Write-output &quot;expected error; should not affect lync account&quot;

 } else {

 throw

 }

 }

 } elseif(\$trgUser.Enabled -eq \$false) {

 Write-output &quot;account was disabled; enable it&quot;

 Set-CsUser –Identity \$guid –Enabled \$True

 } else {

 Write-output &quot;lync account already enabled&quot;

 }
</code></pre>
<hr />
<p><strong>Создание учетки SfB 2 (в скприте процесса)</strong>
 ```
  'Value="get-alias | Where-Object {\$_.name -like 'tee*'}"</p>
<p>Dim theScript As New StringBuilder()</p>
<p>' load modules</p>
<p>' theScript.AppendLine("import-module activedirectory" )</p>
<p>' theScript.AppendLine("\$myname=""tee""")</p>
<p>' theScript.AppendLine("get-alias -Name \$myName")</p>
<p>Dim SAMAccountName As String = \$cn\$</p>
<p>Dim Username As String =
 Connection.GetConfigParm("Custom\SFB\Username")</p>
<p>Dim Password As String =
 Connection.GetConfigParm("Custom\SFB\Password")</p>
<p>Dim RegistrarPool As String =
 Connection.GetConfigParm("Custom\SFB\RegistrarPool")</p>
<p>Dim SipAddressType As String =
 Connection.GetConfigParm("Custom\SFB\SipAddressType")</p>
<p>Dim SipDomain As String =
 Connection.GetConfigParm("Custom\SFB\SipDomain")</p>
<p>Dim URL As String =
 Connection.GetConfigParm("Custom\SFB\URL_oscPowerShell")</p>
<p>theScript.AppendLine("\$creds = New-Object
 System.Management.Automation.PSCredential ('"+Username+"',
 (ConvertTo-SecureString '"+Password+"' -AsPlainText -Force))")</p>
<p>theScript.AppendLine("\$s = New-PSSession -Name SfB -ConnectionUri
 '"+URL+"' -Credential \$creds")</p>
<p>theScript.AppendLine("\$session = Import-PSSession -Session \$s")</p>
<p>theScript.AppendLine("Enable-CsUser -Identity
 'nlmk\+SAMAccountName+"' -RegistrarPool '"+RegistrarPool+"'
 -SipAddressType '"+SipAddressType+"' -SipDomain '"+SipDomain +"'")</p>
<p>theScript.AppendLine("Remove-PSSession -Session \$s")</p>
<p>Value = theScript.ToString()</p>
<p>```</p>
<hr />
<p><strong>Поддержка SQL в сприптах</strong></p>
<pre><code> ' Get the SQL formatter for our connection

 Dim f As ISqlFormatter = Session.SqlFormatter
</code></pre>
<hr />
<h1 id="sql">SQL запрос</h1>
<pre><code>Public Function CCC_GetSingleValueWithOrderBy(UID_PersonWantsOrg As  
String) As String

Dim f As ISqlFormatter = Session.SqlFormatter

Dim WhereClause As String = f.AndRelation(

f.Comparison(&quot;DecisionType&quot;, &quot;Unsubscribe&quot;, ValType.String),

f.Comparison(&quot;UID_PersonWantsOrg&quot;, UID_PersonWantsOrg,  
ValType.String))

Return Session.Source.GetSingleValue(Of String)(Query.

From(&quot;PWODecisionHistory&quot;).

Where(WhereClause).

OrderBy(&quot;DateHead DESC&quot;).

Select(&quot;ReasonHead&quot;))

End Function
</code></pre>
<p>&lt;https://www.oneidentity.com/community/identity-manager/f/forum/21728/orderby-quering-the-database-with-script</p>
<pre><code> &lt;span class=&quot;mark&quot;Dim qApprover = Query.From(Table.PWOHelperPWO,
 &quot;php&quot;).Join(Table.PersonWantsOrg,
 &quot;pwo&quot;).On(**Table.PWOHelperPWO.UID_PersonWantsOrg**).&lt;/span

 &lt;span class=&quot;mark&quot;Select(Table.PersonWantsOrg.DecisionLevel).&lt;/span

 &lt;span class=&quot;mark&quot;Where(&quot;php.UID_PersonHead =
 'e94fd1f7-ecf2-4d5f-9955-f2311a110c39' AND php.LevelNumber =
 pwo.DecisionLevel&quot;)&lt;/span
</code></pre>
<p><a href="https://www.oneidentity.com/community/identity-manager/f/forum/27601/expression-clauses-in-a-query">Expression Clauses in a query - Forum - Identity Manager Community -
 One Identity
 Community</a></p>
<h2 id="join-orderby">С использованием Join и OrderBy</h2>
<p>При использовании OrderBy меняется тип query на Iselect. Чтобы это
 исправить, меняет тив при получении коллекции.</p>
<pre><code> Dim qContentShort = Query.From(&quot;DialogWatchProperty&quot;,
 &quot;watchprop&quot;).Join(Table.DialogWatchOperation,
 &quot;watchop&quot;).On(Table.DialogWatchOperation.UID_DialogWatchOperation).SelectAll().Where(strWhere).OrderBy(&quot;DialogWatchOperation.OperationDate&quot;)


 colRecords = Session.Source.GetCollection(CType(qContentShort, Query))
</code></pre>
<hr />
<p><strong>Получение значения из БД</strong></p>
<pre><code> Dim xValue As String  

 If (Session.Source().TryGetSingleValue(Of String)(&quot;\&lt;tablename\&quot;,
 &quot;\&lt;columnname\&quot;, &quot;\&lt;whereclause\&quot;, xValue)) Then  
 'work with xValue  
 'Else 'make something different  
 End If
</code></pre>
<p>&lt;https://support.oneidentity.com/identity-manager/kb/204144/changed-behaviour-in-the-new-object-layer-api</p>
<hr />
<p><strong>Получение значения из БД 2</strong></p>
<pre><code> Dim xValue As String  
 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim WhereClause As String = f.Comparison(&quot;UID_PersonWantsOrg&quot;,
 UID_PersonWantsOrg, ValType.String,CompareOperator.Equal,
 FormatterOptions.None)

 Session.Source().TryGetSingleValue(Of
 String)(&quot;Table&quot;,&quot;ColumnName&quot;,WhereClause,xValue)

 **ИЛИ**

 XValue = Connection.GetSingleProperty(&quot;AccProductGroup&quot;,
 &quot;UID_AccProductGroup&quot;, WhereClause)
</code></pre>
<hr />
<p><strong>Вычисление родительского подразделения</strong></p>
<pre><code> Dim CompanyCode As String

 Dim ObjectID as String = Right(\$ObjectID\$,8)

 Dim GroupName As String

 Dim ShortName as String = \$ShortName\$

 Dim dbDepartment as IEntity 'объявляем переменную, как объект

 Dim f As ISqlFormatter = Session.SqlFormatter 'для поддержки sql
 запросов и синтаксиса

 Dim strUID_ParentDepartment As String

 Dim strWhere As String

 dbDepartment = session.Source.Get(&quot;Department&quot;, \$UID_Department\$)
 'помещаем объект подразделения по его UID

 CompanyCode = dbDepartment.GetValue(&quot;CustomProperty02&quot;).ToString()
 'помещаем в переменную код компании подразделения

 strUID_ParentDepartment =
 dbDepartment.GetValue(&quot;UID_ParentDepartment&quot;) 'помещаем в переменную
 родительский департамент

 strWhere = f.UidComparison(&quot;UID_Department&quot;, strUID_ParentDepartment)
 'условия сравнения UID подразделения и родительского подразделения

 While string.IsNullOrWhiteSpace(CompanyCode) AND
 Session.Source.Exists(&quot;Department&quot;,strWhere) 'до тех пор, пока Код
 компании = Null и существует родительский департамент

 dbDepartment= session.Source.Get(&quot;Department&quot;,strUID_ParentDepartment)

 CompanyCode = dbDepartment.GetValue(&quot;CustomProperty02&quot;).ToString()

 strUID_ParentDepartment =
 dbDepartment.GetValue(&quot;UID_ParentDepartment&quot;)

 strWhere = f.UidComparison(&quot;UID_Department&quot;, strUID_ParentDepartment)

 End While

 If (not string.IsNullOrWhiteSpace(CompanyCode)) Then

 values(&quot;CompanyCode&quot;) = CompanyCode

 End if

 GroupName = &quot;hab-&quot; + CompanyCode + &quot;-&quot; + ObjectID

 values(&quot;ObjectID&quot;) = ObjectID

 values(&quot;ShortName&quot;) = ShortName

 values(&quot;GroupName&quot;) = GroupName

 values(&quot;Alias&quot;) = GroupName

 values(&quot;CanonicalName&quot;) = &quot;ao.nlmk/HAB/&quot; + GroupName

 values(&quot;DistinguishedName&quot;) = &quot;CN=&quot; + GroupName +
 &quot;,OU=HAB,DC=ao,DC=nlmk&quot;
</code></pre>
<hr />
<p><strong>Получение DistinguishedName по UID</strong></p>
<pre><code> Public Function CCC_Test_UID_ADSContainer(ByVal strUID_ADSContainer As
 String) As String

 ' Get the SQL formatter for our connection

 Dim f As ISqlFormatter = Session.SqlFormatter

 'Dim a As String

 ' Build the WHERE clause for our request

 Dim where As String = f.Comparison(&quot;UID_ADSContainer&quot;,
 strUID_ADSContainer, ValType.String)

 ' Get Ident_Domain of the ADSContainer

 'a = Session.Source.GetSingleValue(Of String)(&quot;ADSContainer&quot;,
 &quot;DistinguishedName&quot;, where)

 Dim xValue As String = &quot;1&quot;

 If (Session.Source().TryGetSingleValue(Of String)(&quot;ADSContainer&quot;,
 &quot;DistinguishedName&quot;, where, xValue)) Then

 'work with xValue

 'Else 'make something different

 End If

 Return xValue

 End Function
</code></pre>
<hr />
<p><strong>Получение UID по имени домена</strong></p>
<pre><code> Public Function CCC_Test_Get_UID_from_Name(ByVal Name As String) As
 String

 ' Get the SQL formatter for our connection

 Dim f As ISqlFormatter = Session.SqlFormatter

 ' Build the WHERE clause for our request

 Dim where As String = f.Comparison(&quot;ADSDomainName&quot;, Name,
 ValType.String)

 ' Get Ident_Domain of the ADSContainer

 'a = Session.Source.GetSingleValue(Of String)(&quot;ADSContainer&quot;,
 &quot;DistinguishedName&quot;, where)

 Dim xValue As String = &quot;1&quot;

 'If (Session.Source().TryGetSingleValue(Of String)(&quot;ADSContainer&quot;,
 &quot;DistinguishedName&quot;, where, xValue)) Then

 'work with xValue

 'Else 'make something different

 'End If

 xValue = Connection.GetSingleProperty(&quot;ADSDomain&quot;, &quot;UID_ADSDomain&quot;,
 where)

 Return xValue

 End Function
</code></pre>
<hr />
<p><strong>Получаем значение из конфиг параметра</strong></p>
<pre><code> Dim URL As String =
 Connection.GetConfigParm(&quot;Custom\Exchange\URL_ExchPowerShell&quot;)
</code></pre>
<hr />
<p><strong>Where в процессе</strong></p>
<pre><code> Процесс SQLComponent - Existsvalues(&quot;GroupOUName&quot;).ToString вычисляем
 в Pre-Script первого блока процесса

 **Dim f As ISqlFormatter = Connection.SqlFormatter**

 **Value = f.Comparison(&quot;cn&quot;, values(&quot;GroupOUName&quot;), ValType.String,
 CompareOperator.Equal)**

  

 values(&quot;GroupOUName&quot;) = GroupOUName
</code></pre>
<p>&lt;img src="../media/3. Scripts/media/image1.png"
 style="width:8.5625in;height:1.51042in"
 alt="Param eters Parameter name Connectionprovider ConnectionString TableName Parameter value Value = Connectionlnfo.ConnectionProvider Value = Connectionlnfo.ConnectionString Value = •ADSContainer• Dim f ISqIFormatter = = f.Comparison(&#39; cn&#39; " /</p>
<p>&lt;img src="../media/3. Scripts/media/image2.png"
 style="width:3.34375in;height:1.08333in"
 alt="Process step properties General Generation Error handling Extended Name Process task Check Exist OU SQLComponent - Exists " /</p>
<hr />
<p><strong>SQL выражение</strong></p>
<p>Для SQLComponent - Execute SQL</p>
<pre><code> Dim f As ISqlFormatter = Connection.SqlFormatter

 Value = &quot;delete ADSAccount where &quot; &amp; f.UIDComparison(&quot;UID_ADSAccount&quot;,
 \$UID_ADSAccount\$)
</code></pre>
<hr />
<p><strong>Работа с коллекциями из объектов БД</strong></p>
<pre><code> Public Function CCC_Test_Unique_CompanyCode(ByVal CompanyCode As
 Integer) As String

 Dim colPersons As IEntityCollection

 Dim strSubType As String

 Dim dbPerson As IEntity

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim Res As String

 **' create the query object**

 Dim qPerson = Query.From(&quot;CCCOrgUnitMapping&quot;).SelectAll()

 **' Load a collection of Person objects**

 colPersons = Session.Source.GetCollection(qPerson)

 ' Run through the list

 For Each colElement As IEntity In colPersons

 dbPerson = colElement.Create(Session, EntityLoadType.Interactive)

 strSubType = dbPerson.GetValue(&quot;CCC_CompanyCode&quot;).String

 Dim qPerson1 = Query.From(&quot;CCCOrgUnitMapping&quot;).Where(Function(c)
 c.Column(&quot;CCC_CompanyCode&quot;) = strSubType).SelectCount()

 Dim iCount = Session.Source.GetCount(qPerson1)

 If iCount = CompanyCode Then

 Return strSubType

 End If

 Next

 Return CompanyCode.ToString()

 End Function
</code></pre>
<hr />
<p><strong>Шаблон параметра деактивации департамента</strong></p>
<pre><code> Dim oDate As DateTime = Convert.ToDateTime(\$CustomProperty08\$)

 If oDate \&lt; Date.UtcNow then

 Value = True

 Else

 Value = False

 End If
</code></pre>
<hr />
<p><strong>Вывести ошибку в Manager при сохранении (Для таблицы - OnSaving)</strong></p>
<pre><code> Dim IPAddress As String = Convert.ToString(Value)

 If Not Regex.IsMatch(IPAddress,
 &quot;^\d{1,3}\\\d{1,3}\\\d{1,3}\\\d{1,3}\$&quot;,
 RegexOptions.CultureInvariant) Then

 Throw New **VIException**(&quot;IP Address submitted is not valid.&quot;,
 ExceptionRelevance.EndUser)

 End If
</code></pre>
<hr />
<h1 id="insert">Не создается запись в БД Insert через тестирование скрипта</h1>
<p>Надо при тестировании скрипта отключить Use Transaction</p>
<p>&lt;img src="../media/3. Scripts/media/image3.png"
 style="width:11.22917in;height:1.14583in"
 alt="Test script String UID_Person, String String UID.Org . • String Parameters _ Person (System.String) ccc (System.String) .Org (System. String) 4b9bebcf-204e4369-acf2-28ea26dd9af9 021 afe9f-c57c4e5e-8334-73045d1 b5780 Run Options • use master connection use transaction Record SQL log " /</p>
<p>&lt;https://www.oneidentity.com/community/identity-manager/f/forum/30974/create-db-objects</p>
<hr />
<h1 id="insert_1">Создание записи в БД Insert</h1>
<pre><code> Public Function CCC_Test_Insert_DbObject(ByVal UID_Person As String,
 ByVal CCC_UID_Point_of_View As String, ByVal UID_Org As String) As
 String

  

 Dim dbCCCPointOfViewInAccProd As IEntity

 dbCCCPointOfViewInAccProd =
 Session.Source.CreateNew(&quot;CCCPointOfViewInAccProd&quot;)

 Using t As New Transaction(Session)

 dbCCCPointOfViewInAccProd.PutValue(&quot;CCC_UID_Person&quot;, UID_Person)

 dbCCCPointOfViewInAccProd.PutValue(&quot;CCC_UID_Point_of_View&quot;,
 CCC_UID_Point_of_View)

 **Using uow As IUnitOfWork = Session.StartUnitOfWork()**

 **uow.Put(dbCCCPointOfViewInAccProd)**

 **uow.Commit()**

 **End Using**

 **t.Commit()**

 End Using

 Return UID_Person

 End Function
</code></pre>
<hr />
<h1 id="_1">Удаление записи из БД</h1>
<pre><code> Public Function CCC_Test_Delete_DbObject(ByVal UID_Person As String,
 ByVal UID_ShoppingCartOrder As String, ByVal UID_PWO As String) As
 String

 Dim CCC_UID_Point_of_View As String

 Dim dbPointOfView As IEntity

 Dim dbPointOfView_new As IEntity

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim Res As String

 ' create the query object

 Dim qPointOfView =
 Query.From(&quot;CCCPointOfViewInAccProd_T&quot;).Where(Function(c)
 c.Column(&quot;CCC_UID_ShoppingCartOrder&quot;) =
 UID_ShoppingCartOrder).SelectAll()

 ' Load a collection of Person objects

 Dim colPointsOfView =
 Session.Source.GetCollection(qPointOfView,EntityCollectionLoadType.Bulk)

 Using uow = Session.StartUnitOfWork()

 ' Walk through the list of all persons

 For Each colElement As IEntity In colPointsOfView

 ' Mark for deletion

 colElement.MarkForDeletion()

 ' put the object in the unit of work

 uow.Put(colElement)

 Next

 ' All person objects will be saved here!

 uow.Commit()

 End Using

 Return UID_Person

 End Function
</code></pre>
<hr />
<h1 id="_2">Обновление записи в БД</h1>
<pre><code> dbcolCCCPersonnelActionsAPI = colElement.Create(Session,
 EntityLoadType.Interactive)

 dbcolCCCPersonnelActionsAPI.**PutValue**(&quot;CCC_InsertedDate&quot;,Date.UtcNow)

  

 Using t As New Transaction(Session)

         Using uow As IUnitOfWork = Session.StartUnitOfWork()

 uow.Put(dbcolCCCPersonnelActionsAPI)

 uow.Commit()

         End Using

         t.Commit()

         End Using

</code></pre>
<hr />
<h1 id="where">Сложный Where</h1>
<pre><code> WhereClause = f.AndRelation( \_

 f.Comparison(&quot;CCC_CompanyCode&quot;, CompanyCode, ValType.String), \_

 f.Comparison(&quot;CCC_City&quot;, City, ValType.String), \_

 f.Comparison(&quot;CCC_CompanySubCode&quot;, CompanySubCode, ValType.String))

 End If
</code></pre>
<hr />
<h1 id="ad-account-definition">Для получения информации по наличии AD Account Definition у сотрудника для почтового шаблона оповещения согласующего при назначении режима доступа</h1>
<pre><code> Public Function CCC_PersonHasTSBAccountDef() As String

 'Таблица PWOHelperPWO

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim UID_PersonOrdered As String =
 \$FK(UID_PersonWantsOrg).UID_PersonOrdered\$

 Dim colPersonHasTSBAccountDef As IEntityCollection

 Dim colTSBAccountDef As IEntityCollection

 Dim dbTSBAccountDef As IEntity

 Dim UID_AccDef As String

 Dim Result As String

 Dim qTSBAccountDef = Query.From(&quot;TSBAccountDef&quot;).Where(Function(c)
 c.Column(&quot;UID_DialogTableAccountType&quot;) =
 &quot;ADS-T-ADSAccount&quot;).SelectAll()

 colTSBAccountDef = Session.Source.GetCollection(qTSBAccountDef)

 For Each colElement As IEntity In colTSBAccountDef

 dbTSBAccountDef = colElement.Create(Session,
 EntityLoadType.Interactive)

 UID_AccDef = dbTSBAccountDef.GetValue(&quot;UID_TSBAccountDef&quot;).String

 Dim qPersonHasTSBAccountDef =
 Query.From(&quot;PersonHasTSBAccountDef&quot;).Where(Function(c)
 c.Column(&quot;UID_Person&quot;) = UID_PersonOrdered And
 c.Column(&quot;UID_TSBAccountDef&quot;) = UID_AccDef ).SelectCount()

 Dim iCount = Session.Source.GetCount(qPersonHasTSBAccountDef)

 If iCount \ 0 Then

 Return &quot;Да&quot;

 End If

 Next

 Return &quot;Нет&quot;

 End Function
</code></pre>
<hr />
<h1 id="_3">Работа с объектом</h1>
<pre><code> Dim dbPWOHelperPWO As IEntity = Session.Source.Get(&quot;PWOHelperPWO&quot;,
 strUID_PWOHelperPWO)

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim strCCC_UID_ShoppingCartOrder As String =
 dbPWOHelperPWO.CreateWalker(Session).GetValue(&quot;FK(UID_PersonWantsOrg).UID_ShoppingCartOrder&quot;).String

 Dim res As String =
 dbPWOHelperPWO.CreateWalker(Session).GetValue(&quot;FK(UID_PersonWantsOrg).FK(ObjectKeyOrdered),QERAssign.FK(ObjectKeyAssignTarget),Org.Ident_Org&quot;).String

 Dim qCCCPointOfViewInAccProd_T =
 Query.From(&quot;CCCPointOfViewInAccProd_T&quot;) \_

 .Where(f.AndRelation( f.UidComparison(&quot;CCC_UID_ShoppingCartOrder&quot;,
 strCCC_UID_ShoppingCartOrder),

 f.UidComparison(&quot;CCC_UID_Person&quot;,strUID_PersonOrdered))) \_

 .Select(&quot;CCC_UID_Point_Of_View&quot;)

 colqCCCPointOfViewInAccProd_T =
 Session.Source.GetCollection(qCCCPointOfViewInAccProd_T)

 For Each colElement As IEntity In colqCCCPointOfViewInAccProd_T

 dbCCCPointOfView = Connection.CreateSingle(&quot;CCCPoint_Of_View&quot;,
 colElement.GetValue(&quot;CCC_UID_Point_Of_View&quot;).String)

 res= res + (dbCCCPointOfView.GetValue(&quot;CCC_Pov_Name&quot;).String) &amp; &quot; &quot;

 Next
</code></pre>
<hr />
<h1 id="update">Update таблицы</h1>
<pre><code> WhereClause

 Dim f As ISqlFormatter = Connection.SqlFormatter

 Value = f.Comparison(&quot;UID_Department&quot;, values(&quot;UID_Dep&quot;),
 ValType.String, CompareOperator.Equal)
</code></pre>
<hr />
<h1 id="sql_1">SQL запрос</h1>
<pre><code> Public Function CCC_GetSingleValueWithOrderBy(UID_PersonWantsOrg As
 String) As String

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim WhereClause As String = f.AndRelation(

 f.Comparison(&quot;DecisionType&quot;, &quot;Unsubscribe&quot;, ValType.String),

 f.Comparison(&quot;UID_PersonWantsOrg&quot;, UID_PersonWantsOrg,
 ValType.String))

  

 Return Session.Source.GetSingleValue(Of String)(Query.

 From(&quot;PWODecisionHistory&quot;).

 Where(WhereClause).

 OrderBy(&quot;DateHead DESC&quot;).

 Select(&quot;ReasonHead&quot;))

 End Function
</code></pre>
<hr />
<h1 id="_4">Добавление в массив уникальных значений из другого массива</h1>
<pre><code> Dim arr1 As New ArrayList()

 Dim Col As New ArrayList()

  

 Arr1.add(&quot;123&quot;)

 Arr1.add(&quot;123&quot;)

  

 For Each I As String In arr1

 If Not Col.Contains(I) Then

 Col.Add(I)

 End If

 Next

 Return Col.Count.ToString()
</code></pre>
<hr />
<p>Сначала выгружаем все записи таблицы, а потом проходимся по каждой и
 добавляем в Лист. Потом в другой лист пишем только уникальные значения
 того листа.</p>
<pre><code>  

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim colUsers As IEntityCollection

 Dim colUsers_unique As IEntityCollection

 Dim dbUser As IEntity

 Dim listUID_UNSAccountB As New List(Of String)

 Dim listUID_UNSAccountBAll As New List(Of String)

  

 Dim qUsers =
 Query.From(&quot;UNSAccountBInUNSGroupB&quot;).Select(&quot;UID_UNSAccountB&quot;)

 colUsers =
 Session.Source.GetCollection(qUsers,EntityCollectionLoadType.Slim)

  

 For Each colElement As IEntity In colUsers

 dbUser = colElement.Create(Session, EntityLoadType.Interactive)

 UID_UNSAccountB = dbUser.GetValue(&quot;UID_UNSAccountB&quot;).String

 listUID_UNSAccountB.Add(UID_UNSAccountB)

 Next

 **listUID_UNSAccountBAll = listUID_UNSAccountB.Distinct().ToList()**

 Return listUID_UNSAccountBAll.count().tostring
</code></pre>
<hr />
<h1 id="-">Вычисление кол-ва согласующих по точкам зрения</h1>
<pre><code> PreScript процесса для таблицы PersonWantsOrg

 Dim UID_ShoppingCartOrder as String = \$UID_ShoppingCartOrder\$

 Dim UID_PWO as String = \$UID_PersonWantsOrg\$

 Dim dbPoV As IEntity 'объявляем переменную, как объект

 Dim dbBalanceUnit As IEntity

 Dim dbDepartment As IEntity

 Dim dbPerson As IEntity

 Dim strCCC_UID_BalanceUnit As String

 Dim strCCC_UID_SanctionDepartment As String

 Dim strUID_PersonHeadDep As String

 Dim strMail_PersonHeadDep As String

 Dim strMail_PersonHeadDep_all As String

 Dim XObjectKey as String

 Dim arr As New ArrayList()

 Dim Col As New ArrayList()

 Dim colPointsOfView As IEntityCollection

 Dim colPWOHelperPWO As IEntityCollection

 Dim CCC_UID_Point_of_View As String

 Dim dbPointOfView As IEntity

 Dim dbPWOHelperPWO As IEntity

 Dim dbPointOfView_new As IEntity

 Dim f As ISqlFormatter = Session.SqlFormatter

 Dim Res As String

 ' create the query object

 Dim qPointOfView =
 Query.From(&quot;CCCPointOfViewInAccProd_T&quot;).Where(Function(c)
 c.Column(&quot;CCC_UID_ShoppingCartOrder&quot;) =
 UID_ShoppingCartOrder).SelectAll()

 Dim qPointOfView_count =
 Query.From(&quot;CCCPointOfViewInAccProd_T&quot;).Where(Function(c)
 c.Column(&quot;CCC_UID_ShoppingCartOrder&quot;) =
 UID_ShoppingCartOrder).SelectCount()

 Dim CountApprover = Session.Source.GetCount(qPointOfView_count)

 ' Load a collection of Person objects

 colPointsOfView = Session.Source.GetCollection(qPointOfView)

 ' Run through the list

 For Each colElement As IEntity In colPointsOfView

 dbPointOfView = colElement.Create(Session, EntityLoadType.Interactive)

 CCC_UID_Point_of_View =
 dbPointOfView.GetValue(&quot;CCC_UID_Point_of_View&quot;).String

 dbPoV = session.Source.Get(&quot;CCCPoint_of_View&quot;, CCC_UID_Point_of_View)
 'помещаем объект Point of View по его UID

 strCCC_UID_BalanceUnit = dbPoV.GetValue(&quot;CCC_UID_BalanceUnit&quot;)

 dbBalanceUnit = session.Source.Get(&quot;CCCBalance_units&quot;,
 strCCC_UID_BalanceUnit) 'помещаем объект Balance_unit по его UID

 strCCC_UID_SanctionDepartment =
 dbBalanceUnit.GetValue(&quot;CCC_UID_SanctionDepartment&quot;)

 dbDepartment = session.Source.Get(&quot;Department&quot;,
 strCCC_UID_SanctionDepartment) 'помещаем объект Department по его UID

 strUID_PersonHeadDep = dbDepartment.GetValue(&quot;UID_PersonHead&quot;)

 **arr.Add(strUID_PersonHeadDep) ' Add to array uid person**

 dbPerson = session.Source.Get(&quot;Person&quot;, strUID_PersonHeadDep)
 'помещаем объект Person по его UID

 strMail_PersonHeadDep = dbPerson.GetValue(&quot;DefaultEmailAddress&quot;)
 'получаем значение DefaultEmailAddress у руководителя департамента

 If (not string.IsNullOrWhiteSpace(strMail_PersonHeadDep)) Then

 strMail_PersonHeadDep_all = strMail_PersonHeadDep + &quot;; &quot; +
 strMail_PersonHeadDep_all

 End If

 Next

 'Calculate XObject PWOHelperPWO for mail template

 Dim qPWOHelperPWO = Query.From(&quot;PWOHelperPWO&quot;).Where(Function(c)
 c.Column(&quot;UID_PersonWantsOrg&quot;) = UID_PWO and
 c.Column(&quot;UID_PWODecisionRule&quot;) =
 &quot;QER-PWODecisionRule-EX&quot;).SelectAll()

 colPWOHelperPWO = Session.Source.GetCollection(qPWOHelperPWO)

 For Each colElement As IEntity In colPWOHelperPWO

 dbPWOHelperPWO = colElement.Create(Session,
 EntityLoadType.Interactive)

 XObjectKey = dbPWOHelperPWO.GetValue(&quot;XObjectKey&quot;).String

 Next

 'Create array from arr with unique values

 For Each I As String In arr

 If Not Col.Contains(I) Then

 Col.Add(I)

 End If

 Next

 values(&quot;Addresses&quot;) = strMail_PersonHeadDep_all

 values(&quot;XObjectKey&quot;) = XObjectKey

 values(&quot;CountApprover&quot;) = Col.Count.ToString()
</code></pre>
<p>&lt;img src="../media/3. Scripts/media/image4.png"
 style="width:9.9375in;height:5.90625in"
 alt="O PersonWantsOrg Calculate CountAp.„ Person Wan tsOrg Calcu late Coun tApprover for Decision Step Update CountApprover for Decisio n Step Make positive decision for requ Process - PersonWantsOrg Calcula... O Perso nWa ntsOrg create PWOHe1perPW0 I O ShoppingCartOrder Send mail Schema Editor Param eters Parameter name V SuthenticationString Connectionprovider ConnectionString ObjectType WhereCIause val_CountApprover ConnectionVariabIes Parameter value value = Connectionlnfo.ÅuthString Value = Connectionlnfo.ConnectionProvider Value = Connectionlnfo.ConnectionString Value = •PVVODecisionStep• Dim f As ISqIFormatter = Connection.SqIFormatter Value = f.ComparisonCUID_PVVODecisionStep , • •ccc-23FA8465854A064181A8113F9F8DIC84•, Val Value = valuesCCountApprover•) Value = •VarllVar21VarY " /</p>
<hr />
<h1 id="_5">Вывод в шаблоне построчно из массива</h1>
<pre><code> Dim DetailStrg As New StringBuilder

  

 DetailStrg.AppendLine(FIO_Attestor)

  

 Return DetailStrg.ToString()
</code></pre>
<hr />
<h1 id="objectwalker">ObjectWalker</h1>
<pre><code> dbPWOHelperPWO_1 = colElement.Create(Session,
 EntityLoadType.Interactive)

 FIO_Attestor =
 dbPWOHelperPWO_1.CreateWalker(Session).GetValue(&quot;FK(UID_PersonHead).InternalName&quot;).String

  

 Dim Pers as ISingleDbObject = Connection.CreateSingle(&quot;Person&quot;,
 \$UID_PersonHead\$)

 Dim culture as String = Pers.Custom.CallMethod(&quot;GetCulture&quot;).ToString

 **Pers.ObjectWalker.GetValue(&quot;FK(UID_DialogCultureFormat).Ident_DialogCulture&quot;).String**
</code></pre>
<hr />
<h1 id="_6">Глобальные и локальные переменные</h1>
<ul>
<li>
<p>Global variables owned by the set up program<br />
  Syntax:<br />
  Value = Variables("\&lt;variable name\")<br />
  Example:<br />
  Value = Variables("GENPROCID")<br />
  Value = Variables("FULLSYNC")</p>
</li>
<li>
<p>Process or process step variables created locally by a pre-script<br />
  Syntax:<br />
  Value = values("Name")<br />
  Example:<br />
  Value = Values("FirstHomeServer")</p>
</li>
</ul>
<p>*From
 \&lt;&lt;https://support.oneidentity.com/technical-documents/identity-manager/8.0/configuration-guide/73*</p>
<h1 id="allocating-parameter-values">Allocating Parameter Values</h1>
<p>Define value templates in VB.Net syntax. The following statements can
 be used for allocating values:</p>
<p>None</p>
<p>Object columns or columns of a related object</p>
<p>Syntax:</p>
<p>Value = \$\&lt;column name\:\&lt;data type\$</p>
<p>Value = \${FK(\&lt;foreign key column).}\&lt;column name\:\&lt;data type\$</p>
<p>Example:</p>
<p>Value = \$Lastname\$</p>
<p>Value = \$PasswordNeverExpires:bool\$</p>
<p>Value = \$FK(Ident_Domain).Description\$</p>
<p>Parameter from the optional parameter collection</p>
<p>Syntax:</p>
<p>Value = \$PC(\&lt;parameter name)\$</p>
<p>Example:</p>
<p>Value = \$PC(SRCUID_Application)\$</p>
<p>Out parameter</p>
<p>Parameters of type "OUT" or "INOUT" are parameters that can be used by
 process components to output a value. This value is then available to
 subsequent process steps in the process and can be used as a value for
 IN parameters.</p>
<p>When you use OUT parameters you need to take care that these contain
 data at runtime. Alternatively, when the text is processed
 "&amp;OUT(\&lt;parameter name)&amp;" is entered, which means that the variable
 will not be replaced.</p>
<p>Syntax:</p>
<p>Value = "&amp;OUT(\&lt;Parameter name)&amp;"</p>
<p>Example:</p>
<p>Value = "&amp;Out(FileSize)&amp;"</p>
<p>Global variables owned by the set up program</p>
<p>Syntax:</p>
<p>Value = Variables("\&lt;variable name\")</p>
<p>Example:</p>
<p>Value = Variables("GENPROCID")</p>
<p>Value = Variables("FULLSYNC")</p>
<p>Process or process step variables created locally by a pre-script</p>
<p>Syntax:</p>
<p>Value = values("Name")</p>
<p>Example:</p>
<p>Value = Values("FirstHomeServer")</p>
<p>Querying Configuration Parameters</p>
<p>The full path for the configuration parameter always has to be
 entered.</p>
<p>Syntax:</p>
<p>Value = Session.Config().GetConfigParm("\&lt;full path\")</p>
<p>Example:</p>
<p>Value = Session.Config().GetConfigParm("TargetSystem\ADS\RestoreMode")</p>
<p>VB.net</p>
<p>Enter any VB.Net statement.</p>
<p><a href="https://support.oneidentity.com/technical-documents/identity-manager/8.0/configuration-guide/73">Identity Manager 8.0 - Configuration Guide
 (oneidentity.com)</a></p>
<hr />
<h1 id="_7">Логирование</h1>
<pre><code> \#If Not SCRIPTDEBUGGER Then

 References VI.DataImport.dll

 Imports System.Collections.Generic

 Imports System.IO

 Imports System.Globalization

 Imports VI.DataImport

 \#End If

  

 Dim SCLOG As String = Session.Config.GetConfigParm(&quot;Custom\LogPath&quot;) +
 &quot;CCC_Department_ImportFromAPI\_&quot; +
 DateTime.Now.ToString(&quot;yyyy-MM-dd&quot;) + &quot;.txt&quot;

  

 Try

 colCCCDepartmentsAPI =
 Session.Source.GetCollection(qCCCDepartmentsAPI)

 Catch ex As Exception

 If Not ex.InnerException Is Nothing AndAlso Not
 ex.InnerException.InnerException Is Nothing Then

 CCC_VID_Write2Log(SCLOG, Environment.NewLine +
 Date.Now.ToString(&quot;yyyy-MM-dd HH:mm:ss&quot;) + &quot; &quot; + &quot;ERROR @ &quot; +
 ex.Message + &quot; &quot; + ex.InnerException.Message + &quot; &quot; +
 ex.InnerException.InnerException.Message + &quot; &quot; + ex.StackTrace)

 ElseIf Not ex.InnerException Is Nothing Then

 CCC_VID_Write2Log(SCLOG, Environment.NewLine +
 Date.Now.ToString(&quot;yyyy-MM-dd HH:mm:ss&quot;) + &quot; &quot; + &quot;ERROR @ &quot; +
 ex.Message + &quot; &quot; + ex.InnerException.Message + &quot; &quot; + ex.StackTrace)

 Else

 CCC_VID_Write2Log(SCLOG, Environment.NewLine +
 Date.Now.ToString(&quot;yyyy-MM-dd HH:mm:ss&quot;) + &quot; &quot; + &quot;ERROR @ &quot; +
 ex.Message + &quot; &quot; + ex.StackTrace)

 End If

  

 End Try
</code></pre>
<hr />
<h2 id="ccc_vid_write2log">CCC_VID_Write2Log</h2>
<pre><code> \#If Not SCRIPTDEBUGGER Then

 References VI.Samba.Tools.dll

 \#End If

  

 Public Sub CCC_VID_Write2Log(ByVal LogFile As String, ByVal Line As
 String)

 Dim logFilePath As System.String

 If Not AppData.Instance.RuntimeEnvironment.IsMono Then

 logFilePath = PathHelper.ConvertSeparators(LogFile)

 Else

 Dim sambaUncPath As New VI.Samba.Tools.SambaUncPath(LogFile)

 If Not sambaUncPath.IsLocal Then

 Throw New System.Exception(#LD(&quot;UNC-path &quot;&quot;{0}&quot;&quot; does not reference a
 local path.&quot;, LogFile)#)

 Else

 logFilePath = sambaUncPath.LocalPath

 End If

 End If

  

 Dim f As System.IO.StreamWriter = Nothing

  

 Try

 f = New System.IO.StreamWriter(logFilePath, True,
 System.Text.Encoding.UTF8)

  

 f.NewLine() = Chr(13) &amp; Chr(10)

 f.WriteLine(Line)

 Catch exc As System.Exception

 Throw New System.Exception(#LD(&quot;The path is '{0}'.&quot;, logFilePath)#,
 exc)

 Finally

 If Not f Is Nothing Then

 f.Flush()

 f.Close()

 End If

 End Try

 End Sub
</code></pre>
<hr />
<h2 id="_8">Строки</h2>
<p>Несколько строк</p>
<pre><code> Dim DetailStrg As New StringBuilder

 DetailStrg.AppendLine(&quot;qq&quot;)

 Return DetailStrg.ToString()
</code></pre>
<hr />
<h1 id="where_1">WHERE</h1>
<pre><code> Dim f As ISqlFormatter = Session.SqlFormatter()

 Value = f.UidComparison(&quot;UID_ADSAccount&quot;, \$UID_ADSAccount\$)
</code></pre>
<hr />
<h1 id="export-to-csv">EXPORT TO CSV</h1>
<h1 id="csvexportsingle">CSVExportSingle</h1>
<p>&lt;https://www.oneidentity.com/community/identity-manager/f/forum/30780/export-selectet-data-from-a-new-created-user-into-a-csv-file</p>
<h2 id="_9">Формат даты</h2>
<pre><code> Dim asd As String = expenddt.ToString(&quot;dd/MM/yyyy&quot;)
</code></pre>
<p>*From
 \&lt;&lt;https://coderoad.ru/8644398/%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82-%D0%B4%D0%B0%D1%82%D1%8B-%D0%B2-vb-net*</p>
<h2 id="objectwalker_1">ObjectWalker</h2>
<pre><code> Public Function CCC_Test_ObjectWalker (ByVal UID_PWO As String) As
 String

 Dim dbPWO As IEntity

 Dim strDisplayOrg As String

 Dim strDisplayOrgParent As String

 Dim strCCC_BPMServiceID As String

  

  

 dbPWO = Session.Source.Get(&quot;PersonWantsOrg&quot;, UID_PWO)

 strDisplayOrg =
 dbPWO.CreateWalker(Session).GetValue(&quot;DisplayOrg&quot;).String

 strDisplayOrgParent =
 dbPWO.CreateWalker(Session).GetValue(&quot;DisplayOrgParent&quot;).String

 'strCCC_BPMServiceID =
 dbPWO.CreateWalker(Session).GetValue(&quot;FK(UID_OrgParentOfParent).FK(UID_AccProduct).FK(UID_AccProductGroup).CCC_BPMServiceID&quot;).String

 strCCC_BPMServiceID =
 dbPWO.CreateWalker(Session).GetValue(&quot;FK(UID_Org).FK(UID_AccProduct).FK(UID_AccProductGroup).CCC_BPMServiceID&quot;).String

  

  

 Return strCCC_BPMServiceID

 End Function
</code></pre>
<hr />
<h1 id="greenplum-postgress">Взаимодействие с GreenPlum (Postgress)</h1>
<p>Надо установить odbc драйвер</p>
<p>&lt;https://www.postgresql.org/ftp/odbc/versions/msi/</p>
<p>После этого можно юзать подключение, через ADO .NET (<a href="read://https_metanit.com/?url=https%3A%2F%2Fmetanit.com%2Fsharp%2Fadonet%2F1.1.php">Введение в
 ADO.NET
 (https_metanit.com)</a>)</p>
<pre><code> Public Sub CCC_Test_GreenPlum_TestConnection()

 Dim MyCon As New Odbc.OdbcConnection

 MyCon.ConnectionString = &quot;**Driver={PostgreSQL
 ANSI**};database=test001;server=[REDACTED_HOST];port=5432;uid=[REDACTED_USER];sslmode=disable;readonly=0;protocol=7.4;User
 ID=[REDACTED_USER];password=[REDACTED];&quot;

  

 MyCon.Open()

 If MyCon.State = ConnectionState.Open Then

 MsgBox(&quot;Connected To PostGres&quot;, MsgBoxStyle.MsgBoxSetForeground)

 End If

 End Sub
</code></pre>
<hr />
<h6 id="idbcommand-interface"><em>IDbCommand Interface</em></h6>
<p>*From
 \&lt;&lt;https://docs.microsoft.com/en-us/dotnet/api/system.data.idbcommand?view=net-5.0*</p>
<p>Обновляем данные в таблице постгресс</p>
<pre><code> Public Sub CCC_Test_GreenPlum_UpdateValue()

 Dim MyCon As New Odbc.OdbcConnection

 Dim DB = Connection.GetConfigParm(&quot;Custom\GreenPlum\GreenplumDB&quot;)

 Dim ConnPort =
 Connection.GetConfigParm(&quot;Custom\GreenPlum\ConnectionPort&quot;)

 Dim Srv = Connection.GetConfigParm(&quot;Custom\GreenPlum\GreenplumMaster&quot;)

 Dim ConnUser =
 Connection.GetConfigParm(&quot;Custom\GreenPlum\ConnectionUser&quot;)

 Dim ConnUserPass =
 Connection.GetConfigParm(&quot;Custom\GreenPlum\ConnectionUserPassword&quot;)

  

 Dim strSQL As String = &quot;UPDATE AccessRights SET dimensionvalue =
 'TestValue003' WHERE username = 'Alex';&quot;

 Dim strUserName As String

  

 MyCon.ConnectionString = &quot;Driver={PostgreSQL ANSI};Database=&quot; + DB +
 &quot;;Server=&quot; + Srv + &quot;;Port=&quot; + ConnPort + &quot;;Uid=&quot; + ConnUser +
 &quot;;Pwd=&quot; + ConnUserPass +&quot;;&quot;

  

 MyCon.Open()

 ' Create a database command object

 Using dbCommand As IDbCommand = MyCon.CreateCommand()

 ' Set the SQL statement to execute

 dbCommand.CommandText = strSQL

  

 dbCommand.ExecuteNonQuery()

 End Using

  

 MyCon.Close()

 End Sub
</code></pre>
<hr />
<h1 id="_10">Кавычки в скриптах</h1>
<p>Для postgress, чтобы создать роль с точкой в имени, надо заключить имя
 в кавычки</p>
<p>Чтобы сделать это в Vb.Net надо написать</p>
<p>&lt;span class="mark""""" (4 кавычки!!!)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
