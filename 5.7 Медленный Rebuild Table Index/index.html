<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>5.7 Медленный Rebuild Table Index - 1IM Wiki</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" >
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">1IM Wiki</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="true">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#qbm_zindexrebuild" class="nav-link">QBM_ZIndexRebuild</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#qbm_pindexrebuild" class="nav-link">QBM_PIndexRebuild</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#1" class="nav-link">Вариант решения 1.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#2" class="nav-link">Вариант решения 2</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>5.7 Медленный Rebuild Table Index</p>
<p>9 апреля 2024 г.</p>
<p>16:41</p>
<h2 id="qbm_zindexrebuild">QBM_ZIndexRebuild</h2>
<p><strong>8.1.3</strong></p>
<p>USE [OneIM]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_ZIndexRebuild]
Script Date: 09.04.2024 16:48:06 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_ZIndexRebuild] ( @SlotNumberDummy int ,
@TableName varchar(38), @dummy1 varchar(38) = '', @dummy2 varchar(38) =
'' ) as begin BEGIN</p>
<p>TRY exec QBM_PIndexRebuild @TableName END TRY BEGIN CATCH declare
@ErrorMessage nvarchar(4000) declare @ErrorSeverity int declare
@ErrorState int select</p>
<p>@ErrorSeverity = dbo.QBM_FGIErrorSeverity() select @ErrorState = 1
select @ErrorMessage = dbo.QBM_FGIErrorMessage() exec
QBM_PRollbackIfAllowed RAISERROR</p>
<p>(@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT END CATCH end</p>
<p><strong>8.2</strong></p>
<p>USE [OneIM82]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_ZIndexRebuild]
Script Date: 09.04.2024 16:55:14 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_ZIndexRebuild] ( @SlotNumberDummy int ,
@TableName varchar(38), @dummy1 varchar(38) = '', @GenProcID varchar(38)
= '' ) as begin</p>
<p>declare @Message nvarchar(1000) = '#LDS#Reindexing of {0} was not
performed due to the size of the table.|' + @tablename + '|' BEGIN TRY
if ISNULL(@GenProcID</p>
<p>, '') = '' begin select @GenProcID = dbo.QBM_FGISessionContext('') end
if exists (select top 1 1 from DialogTable t where t.TableName =
@tableName and</p>
<p>( t.SizeMB &gt; 1024.0 or dbo.QBM_FGITableCountAll(t.TableName) &gt; 1000000
) ) begin exec QBM_PJournal @Message, @@procid, 'I', 'I', 100 goto
endLabel end</p>
<p>if 1=0 begin exec QBM_PIndexRebuild @TableName end else begin declare
@SQL33734 nvarchar(max) = concat('exec QBM_PIndexRebuild ''',
@TableName, '''' )</p>
<p>exec QBM_PJobCreate_Mnt @SQL33734, @GenProcID end END TRY BEGIN CATCH
declare @ErrorMessage nvarchar(4000) declare @ErrorSeverity int declare
@ErrorState</p>
<p>int select @ErrorSeverity = dbo.QBM_FGIErrorSeverity() select
@ErrorState = 1 select @ErrorMessage = dbo.QBM_FGIErrorMessage() exec
QBM_PRollbackIfAllowed</p>
<p>RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT END
CATCH endLabel: return end</p>
<p><strong>QBM_PJobCreate_Mnt</strong></p>
<p>USE [OneIM82]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_PJobCreate_Mnt]
Script Date: 10.04.2024 15:41:09 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>create procedure [dbo].[QBM_PJobCreate_Mnt] (@SQLCmd nvarchar(max) ,
@GenProcID varchar(38) ) as begin declare @Parameters QBM_YParameterList
declare @ComponentClass</p>
<p>nvarchar(256) = 'VI.JobService.JobComponents.SQLComponent' declare
@TaskName nvarchar(64) = 'Execute SQL' declare @QueueName nvarchar(128)
= case dbo.QBM_FGIWithoutAgentAndBroker</p>
<p>() when 0 then 'QBM_PDBQueueProcess_Mnt' else 'QBM_PWorkMaintenance' end
BEGIN TRY insert into @Parameters (Parameter1, ContentFull) values
('SQLStmt'</p>
<p>, @sqlcmd) , ('WithoutTransaction', '1') if not exists (select top 1 1
from JobQueue q with (readpast) where q.ComponentClass = @ComponentClass
and q.TaskName</p>
<p>= @TaskName and q.Queue = @QueueName and q.ParamIN like CONCAT('%',
replace(@SQLCmd, '''', ''''''), '%') ) begin exec QBM_PJobCreate
@ComponentClass</p>
<p>, @TaskName , @Parameters , @GenProcID , @ObjectKeysAffected = default ,
@QueueName = @QueueName end END TRY BEGIN CATCH declare @ErrorMessage
nvarchar</p>
<p>(4000) declare @ErrorSeverity int declare @ErrorState int select
@ErrorSeverity = dbo.QBM_FGIErrorSeverity() select @ErrorState = 1
select @ErrorMessage</p>
<p>= dbo.QBM_FGIErrorMessage() exec QBM_PRollbackIfAllowed @GenProcID
RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT END
CATCH ende:</p>
<p>return end</p>
<p>GO</p>
<h2 id="qbm_pindexrebuild">QBM_PIndexRebuild</h2>
<p><strong>8.1.3</strong></p>
<p>USE [OneIM]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_PIndexRebuild]
Script Date: 09.04.2024 16:49:11 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_PIndexRebuild] ( @TableName nvarchar(30)
) as begin declare @SQLcmd nvarchar(max) declare @tableID int declare
@SQLcmds QBM_YCursorBuffer</p>
<p>declare @ElementCount int declare @ElementIndex int declare
@DebugStarttime datetime = getutcdate() declare @DebugLevel char(1) =
'W' BEGIN TRY if @@TRANCOUNT</p>
<p>&gt; 0 begin goto endlabel end if isnull(@TableName, '') = '' begin goto
ende end select @tableID = null select top 1 @tableID = OBJECT_ID from
sys.tables</p>
<p>where name = @TableName exec QBM_PTableLockEscalationSet @TableName if
@TableName in (select TableName from QBM_VHeavyLoadTables ) begin goto
ende end</p>
<p>if not exists (select top 1 1 from information_schema.tables where
table_name = @TableName and table_type = 'BASE TABLE' ) or @tableID is
null begin</p>
<p>select @SQLcmd = N'No reorganize for Table ' + @TableName + N' Table not
exists' exec QBM_PJournal @SQLcmd, @@procid, 'W', @DebugLevel goto ende
end insert</p>
<p>into @SQLcmds (ContentFull) SELECT N'ALTER INDEX "' + x.indexname + N'"
ON ' + schemaname + N'.' + x.TableName + case when percentFrag \&lt; 20.0
and index_id</p>
<p>&gt; 1 then N' REORGANIZE' else
dbo.QBM_FGIDBServerIndexRebuildOpt(x.TableName) end from ( select
distinct OBJECT_SCHEMA_NAME(frag.object_id) as schemaname</p>
<p>, OBJECT_NAME(frag.object_id) as TableName, six.name as indexname,
frag.avg_fragmentation_in_percent as percentFrag , frag.index_id from (
select fr.object_id</p>
<p>, fr.index_id, sum(convert(float, record_count) *
avg_fragmentation_in_percent / 100.0)/ sum(convert(float, record_count))
* 100.0 as avg_fragmentation_in_percent</p>
<p>FROM sys.dm_db_index_physical_stats ( DB_ID(), @tableID, DEFAULT, 0,
'detailed' ) as fr where fr.record_count &gt; 0 group by fr.object_id,
fr.index_id</p>
<p>) as frag JOIN sys.indexes six ON frag.object_id = six.object_id AND
frag.index_id = six.index_id where six.name is not null and
frag.avg_fragmentation_in_percent</p>
<p>&gt; 10.0 and frag.object_ID = @tableID and six.is_hypothetical = 0 ) as x
where TableName = @TableName order by x.index_id select @ElementCount =
@@rowcount</p>
<p>if @ElementCount &gt; 0 begin select @SQLCmd = N'ALTER INDEX ALL ON ' +
@TableName + N' SET (ALLOW_PAGE_LOCKS = ON)' exec QBM_PJournal @SQLcmd,
@@PROCID</p>
<p>, 'D', @DebugLevel exec QBM_PExecuteSQL @SQLcmd, @@procid select
@ElementIndex = 1 while @ElementIndex \&lt;= @ElementCount begin select top
1 @SQLcmd = bu.ContentFull</p>
<p>from @SQLcmds bu where bu.ElementIndex = @ElementIndex exec QBM_PJournal
@sqlcmd, @@PROCID, 'D', @DebugLevel exec QBM_PExecuteSQL @SQLcmd,
@@procid select</p>
<p>@ElementIndex += 1 end end select @SQLCmd = N'ALTER INDEX ALL ON ' +
@TableName + N' SET (ALLOW_ROW_LOCKS = ON)' exec QBM_PJournal @SQLcmd,
@@PROCID</p>
<p>, 'D', @DebugLevel exec QBM_PExecuteSQL @SQLcmd, @@procid select @SQLCmd
= N'ALTER INDEX ALL ON ' + @TableName + N' SET (ALLOW_PAGE_LOCKS = OFF)'
exec</p>
<p>QBM_PJournal @SQLcmd, @@PROCID, 'D', @DebugLevel exec QBM_PExecuteSQL
@SQLcmd, @@procid select @SQLCmd = N'UPDATE STATISTICS ' + @TableName +
N' WITH FULLSCAN '</p>
<p>exec QBM_PExecuteSQL @SQLcmd, @@procid ende: return END TRY BEGIN CATCH
declare @ErrorMessage nvarchar(4000) declare @ErrorSeverity int declare
@ErrorState</p>
<p>int select @ErrorSeverity = dbo.QBM_FGIErrorSeverity() select
@ErrorState = 1 select @ErrorMessage = dbo.QBM_FGIErrorMessage() exec
QBM_PRollbackIfAllowed</p>
<p>RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT END
CATCH endLabel: return end</p>
<p><strong>8.2</strong></p>
<p>USE [OneIM82]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_PIndexRebuild]
Script Date: 09.04.2024 16:52:38 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_PIndexRebuild] ( @TableName nvarchar(30)
) as begin declare @SQLcmd nvarchar(max) declare @tableID int declare
@SQLcmds QBM_YCursorBuffer</p>
<p>declare @ElementCount int declare @ElementIndex int declare @DebugLevel
char(1) = 'W' declare @GenProcID varchar(38) =
dbo.QBM_FGISessionContext('') BEGIN</p>
<p>TRY if @@TRANCOUNT &gt; 0 begin goto endlabel end if isnull(@TableName,
'') = '' begin goto ende end select @tableID = null select top 1
@tableID = OBJECT_ID</p>
<p>from sys.tables where name = @TableName exec QBM_PTableLockEscalationSet
@TableName if @TableName in (select TableName from QBM_VHeavyLoadTables
) begin</p>
<p>goto ende end if not exists (select top 1 1 from
information_schema.tables where table_name = @TableName and table_type =
'BASE TABLE' ) or @tableID</p>
<p>is null begin select @SQLcmd = N'No reorganize for Table ' +
@TableName + N' Table not exists' exec QBM_PJournal @SQLcmd, @@procid,
'W', @DebugLevel goto</p>
<p>ende end insert into @SQLcmds (ContentFull) SELECT N'ALTER INDEX "' +
x.indexname + N'" ON ' + schemaname + N'.' + x.TableName + case when
percentFrag</p>
<p>\&lt; 20.0 and index_id &gt; 1 then N' REORGANIZE' else
dbo.QBM_FGIDBServerIndexRebuildOpt(x.TableName) end from ( select
distinct OBJECT_SCHEMA_NAME(frag.object_id</p>
<p>) as schemaname, OBJECT_NAME(frag.object_id) as TableName, six.name as
indexname, frag.avg_fragmentation_in_percent as percentFrag ,
frag.index_id from</p>
<p>( select fr.object_id, fr.index_id, sum(convert(float, record_count) *
avg_fragmentation_in_percent / 100.0)/ sum(convert(float, record_count))
* 100.0</p>
<p>as avg_fragmentation_in_percent FROM sys.dm_db_index_physical_stats (
DB_ID(), @tableID, DEFAULT, 0, 'detailed' ) as fr where fr.record_count
&gt; 0</p>
<p>group by fr.object_id, fr.index_id ) as frag JOIN sys.indexes six with
(readpast) ON frag.object_id = six.object_id AND frag.index_id =
six.index_id where</p>
<p>six.name &gt; ' ' and frag.avg_fragmentation_in_percent &gt; 10.0 and
frag.object_ID = @tableID and six.is_hypothetical = 0 ) as x where
TableName = @TableName</p>
<p>order by x.index_id select @ElementCount = @@rowcount if @ElementCount
&gt; 0 begin select @SQLCmd = N'ALTER INDEX ALL ON ' + @TableName + N' SET
(ALLOW_PAGE_LOCKS = ON)'</p>
<p>exec QBM_PJournal @SQLcmd, @@PROCID , 'D', @DebugLevel exec
QBM_PExecuteSQL @SQLcmd, @@procid select @ElementIndex = 1 while
@ElementIndex \&lt;= @ElementCount</p>
<p>begin select top 1 @SQLcmd = bu.ContentFull from @SQLcmds bu where
bu.ElementIndex = @ElementIndex exec QBM_PJournal @sqlcmd, @@PROCID,
'D', @DebugLevel</p>
<p>exec QBM_PExecuteSQL @SQLcmd, @@procid select @ElementIndex += 1 end end
exec QBM_PSetRowLockOnly @TableName if not exists (select top 1 1 from
DialogDBQueue</p>
<p>q with (readpast) where q.UID_Task = 'QBM-K-UpdateStatistics' ) begin
exec QBM_PDBQueueInsert_Single 'QBM-K-UpdateStatistics', '', '',
@GenProcID end</p>
<p>ende: return END TRY BEGIN CATCH declare @ErrorMessage nvarchar(4000)
declare @ErrorSeverity int declare @ErrorState int select @ErrorSeverity
= dbo.QBM_FGIErrorSeverity</p>
<p>() select @ErrorState = 1 select @ErrorMessage =
dbo.QBM_FGIErrorMessage() exec QBM_PRollbackIfAllowed RAISERROR
(@ErrorMessage, @ErrorSeverity, @ErrorState</p>
<p>) WITH NOWAIT END CATCH endLabel: return end</p>
<p><strong>PSetRowLockOnly</strong></p>
<p>USE [OneIM82]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_PSetRowLockOnly]
Script Date: 09.04.2024 16:59:09 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_PSetRowLockOnly] (@TablePattern
nvarchar(64) = '%' ) as begin declare @SQLcmd1 nvarchar(1024) declare
@SQLcmd2 nvarchar(1024) declare</p>
<p>@ElementBuffer QBM_YCursorBuffer declare @ElementCount int declare
@ElementIndex int declare @DebugSwitch int = 0 BEGIN TRY set nocount on
insert into</p>
<p>@ElementBuffer(ContentShort , ContentFull ) select case
i.allow_row_locks when 0 then concat('exec sp_indexoption ''' , o.name ,
'.' , t.name , case when</p>
<p>i.type_desc = 'HEAP' and i.name is null then '' else '.' + i.name end ,
''', ''AllowRowLocks'', ''True'' ' ) else '' end , case
i.allow_page_locks when</p>
<p>1 then concat('exec sp_indexoption ''' , o.name , '.' , t.name , case
when i.type_desc = 'HEAP' and i.name is null then '' else '.' + i.name
end , ''', ''AllowPageLocks'', ''False'' '</p>
<p>) else '' end from sys.tables t join sys.schemas o on t.schema_id =
o.schema_id and dbo.QBM_FGIObjectIsDropable (o.schema_id)=1 join
sys.indexes i on</p>
<p>i.object_id = t.object_id where t.type = 'U' and t.name like
@TablePattern and t.is_memory_optimized = 0 and i.is_hypothetical = 0
and t.name not like</p>
<p>'sys%' and t.name not like 'ms%' and t.name not like 'IH%' and t.name
not like 'conflict%' and (i.allow_row_locks = 0 or i.allow_page_locks =
1 ) and</p>
<p>i.type_desc in ('CLUSTERED', 'NONCLUSTERED', 'HEAP') order by o.name,
t.name, i.name select @ElementCount = @@ROWCOUNT select @ElementIndex =
1 while</p>
<p>@ElementIndex \&lt;= @ElementCount begin select top 1 @SQLcmd1 =
bu.ContentShort , @SQLcmd2 = bu.ContentFull from @ElementBuffer bu where
bu.ElementIndex =</p>
<p>@ElementIndex if @DebugSwitch &gt; 0 begin print @SQLcmd1 print @SQLcmd2
end if @SQLcmd1 &gt; ' ' begin exec QBM_PExecuteSQL @SQLcmd1, @@procid end
if @SQLcmd2</p>
<p>&gt; ' ' begin exec QBM_PExecuteSQL @SQLcmd2, @@procid end select
@ElementIndex += 1 end END TRY BEGIN CATCH declare @ErrorMessage
nvarchar(4000) declare</p>
<p>@ErrorSeverity int declare @ErrorState int select @ErrorSeverity =
dbo.QBM_FGIErrorSeverity() select @ErrorState = 1 select @ErrorMessage =
dbo.QBM_FGIErrorMessage</p>
<p>() exec QBM_PRollbackIfAllowed RAISERROR (@ErrorMessage, @ErrorSeverity,
@ErrorState) WITH NOWAIT END CATCH end</p>
<p><strong>--------</strong></p>
<p><strong>--------</strong></p>
<h1 id="1">Вариант решения 1.</h1>
<ol>
<li>Создаем процедуру - заглушку</li>
</ol>
<blockquote>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>CREATE PROCEDURE [dbo].[ClearProc]</p>
<p>AS</p>
<p>BEGIN</p>
<p>SET NOCOUNT ON;</p>
<p>END</p>
<p>GO</p>
</blockquote>
<ol>
<li>Вносим изменения в процедуру QBM_ZIndexRebuild</li>
</ol>
<blockquote>
<p>USE [OneIM]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_ZIndexRebuild]
Script Date: 12.04.2024 11:53:34 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER procedure [dbo].[QBM_ZIndexRebuild] ( @SlotNumberDummy int ,
@TableName varchar(38), @dummy1 varchar(38) = '', @dummy2 varchar(38)
= '' ) as begin BEGIN</p>
<p>TRY exec <strong>ClearProc</strong> END TRY BEGIN CATCH declare @ErrorMessage
nvarchar(4000) declare @ErrorSeverity int declare @ErrorState int
select</p>
<p>@ErrorSeverity = dbo.QBM_FGIErrorSeverity() select @ErrorState = 1
select @ErrorMessage = dbo.QBM_FGIErrorMessage() exec
QBM_PRollbackIfAllowed RAISERROR</p>
<p>(@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT END CATCH end</p>
</blockquote>
<h1 id="2">Вариант решения 2</h1>
<blockquote>
<p>Вносим изменения в процедуру QBM_ZIndexRebuild для учета размеров БД и
кол-ва записей в них</p>
<p>USE [OneIM]</p>
<p>GO</p>
<p>/****** Object: StoredProcedure [dbo].[QBM_ZIndexRebuild]
Script Date: 12.04.2024 11:53:34 ******/</p>
<p>SET ANSI_NULLS ON</p>
<p>GO</p>
<p>SET QUOTED_IDENTIFIER ON</p>
<p>GO</p>
<p>ALTER PROCEDURE [dbo].[QBM_ZIndexRebuild]</p>
<p>(</p>
<p>@SlotNumberDummy INT,</p>
<p>@TableName VARCHAR(38),</p>
<p>@dummy1 VARCHAR(38) = '',</p>
<p>@dummy2 VARCHAR(38) = ''</p>
<p>)</p>
<p>AS</p>
<p>BEGIN</p>
<p>DECLARE @Message NVARCHAR(1000) = '#LDS#Reindexing of {0} was not
performed due to the size of the table.|' + @tablename + '|'</p>
<p>BEGIN TRY</p>
<p>IF EXISTS (</p>
<p>SELECT TOP 1 1</p>
<p>FROM DialogTable t</p>
<p>WHERE t.TableName = @tableName</p>
<p>AND (</p>
<p>t.SizeMB &gt; 1024.0</p>
<p>OR dbo.QBM_FGITableCountAll(t.TableName) &gt; 1000000</p>
<p>)</p>
<p>)</p>
<p>BEGIN</p>
<p>EXEC QBM_PJournal @Message, @@procid, 'I', 'I', 100</p>
<p>GOTO endLabel</p>
<p>END</p>
<p>BEGIN</p>
<p>EXEC QBM_PIndexRebuild @TableName</p>
<p>END</p>
<p>END TRY</p>
<p>BEGIN CATCH</p>
<p>DECLARE @ErrorMessage NVARCHAR(4000)</p>
<p>DECLARE @ErrorSeverity INT</p>
<p>DECLARE @ErrorState INT</p>
<p>SELECT @ErrorSeverity = dbo.QBM_FGIErrorSeverity()</p>
<p>SELECT @ErrorState = 1</p>
<p>SELECT @ErrorMessage = dbo.QBM_FGIErrorMessage()</p>
<p>EXEC QBM_PRollbackIfAllowed</p>
<p>RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState) WITH NOWAIT</p>
<p>END CATCH</p>
<p>endLabel:</p>
<p>RETURN</p>
<p>END</p>
</blockquote></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
